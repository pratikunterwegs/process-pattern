---
editor_options: 
  chunk_output_type: console
---

# Plot variation within and between scenarios

```{r}
library(data.table)
library(ggplot2)
library(colorspace)
library(patchwork)

# local funs
source("R/fun_wt_vals.R")
```

## Load data

```{r}
data = fread("data/data_gens_dist_summary.csv")
```

## Summarise energy

```{r}
data_int_summary = data[, list(
  mean_int = mean(intake),
  sd_int = sd(intake)
), by = c("type", "growth", "g", "rep_")]
```

```{r}
plot_intake_gen =
  ggplot(data_int_summary[growth == 0.01 & type != "random"])+
  geom_ribbon(
    aes(g, 
        ymin = mean_int - sd_int,
        ymax = mean_int + sd_int,
        group = rep_
    ),
    fill = "transparent",
    col = "grey90",
    size = 0.1
  )+
  geom_path(
    aes(g, mean_int,
        group = rep_),
    col = "darkgreen"
  )+
  facet_wrap(~type, scales = "free_y",
             labeller = labeller(
               type = c(
                 "exploit" = "Exploit. comp.",
                 "interf" = "Interf. comp."
               )
             )
  )+
  theme_classic(
    base_size = 10
  )+
  theme(
    legend.position = "top",
    legend.key.height = unit(2, units = "mm"),
    strip.background = element_blank(),
    strip.text = element_text(
      face = "italic"
    ),
    panel.grid.minor = element_blank()
  )+
  coord_cartesian(
    expand = F,
    # xlim = c(0, 260),
    ylim = c(0, 50)
  )+
  labs(
    y = "Intake",
    x = "Generation",
    fill = "# Agents"
  )
```

## Summarise distance

```{r}
data_dist_summary = data[, list(
  mean_dist = mean(distance),
  sd_dist = sd(distance)
), by = c("type", "growth", "g", "rep_")]
```

```{r}
plot_dist_gen =
  ggplot(data_dist_summary[growth == 0.01 & type != "random"])+
  geom_ribbon(
    aes(g, 
        ymin = mean_dist - sd_dist,
        ymax = mean_dist + sd_dist,
        group = rep_
    ),
    fill = "transparent",
    col = "grey90",
    size = 0.1
  )+
  geom_path(
    aes(g, mean_dist,
        group = rep_),
    col = "steelblue"
  )+
  facet_wrap(~type, scales = "free_y",
             labeller = labeller(
               type = c(
                 "exploit" = "Exploit. comp.",
                 "interf" = "Interf. comp."
               )
             )
  )+
  theme_classic(
    base_size = 10
  )+
  theme(
    legend.position = "top",
    legend.key.height = unit(2, units = "mm"),
    strip.background = element_blank(),
    strip.text = element_text(
      face = "italic"
    ),
    panel.grid.minor = element_blank()
  )+
  coord_cartesian(
    expand = F,
    ylim = c(0, 350)
  )+
  labs(
    y = "Distance",
    x = "Generation",
    fill = "# Agents"
  )
```

## Summarise weight evolution

```{r}
data_wt = data[, c("id", "g", "growth", "type", "rep_",
                      sprintf("wt_%i", seq(2, 4, 1)))]

# count props
data_wt_count = melt(data_wt, id.vars = c("id", "g", "growth", "type", "rep_"))
data_wt_count[, value := cut_wt_lower(value, steps = 25, scale = 40)]
data_wt_count = data_wt_count[, list(pW = .N / 100), 
              by = c("growth", "g", "type", "rep_", "variable", "value")]

# rename weights
data_wt_count[, variable := dplyr::case_when(
  variable == "wt_2" ~ "sN",
  variable == "wt_3" ~ "sH",
  variable == "wt_4" ~ "sP"
)]

# subset for index case
data_wt_count = data_wt_count[growth == 0.01 & type != "random" & rep_ < 4, ]

data_wt_count = split(data_wt_count, by = "type")
```


```{r}
plot_wt_evo = function(df) {
  ggplot(df[growth == 0.01 & type != "random"])+
  geom_hline(
    yintercept = 0, lty = 2,
    col = "grey"
  )+
  geom_tile(
    aes(g, value, fill = pW),
    width = 10
  )+
  scale_fill_viridis_c(
    option = "A", direction = -1,
    limits = c(0.02, 1),
    na.value = "transparent",
    label = scales::percent
  )+
  scale_y_continuous(
    trans = ggallin::ssqrt_trans
  )+
  facet_grid(
    rep_~variable, scales = "free_y",
    labeller = labeller(
      rep_ = label_both
    )
  )+
  theme_classic(
    base_size = 10
  )+
  theme(
    legend.position = "top",
    legend.text = element_text(size = 8),
    legend.title = element_text(size = 8),
    legend.key.height = unit(1, "mm"),
    # legend.key.height = unit(2, "mm"),
    strip.background = element_blank(),
    strip.text = element_text(
      face = "italic"
    ),
    panel.border = element_rect(
      colour = "grey",
      fill = NA,
      size = 0.1
    )
  )+
  coord_cartesian(
    ylim = c(-1, 1)
  )+
  labs(
    x = "Generation",
    y = "Scaled weight value",
    fill = "% Agents"
  )
}
```

```{r}
plots_wt_evo = lapply(data_wt_count[c("exploit", "interf")], plot_wt_evo)
```

## Wrap figures

```{r}
fig_evo_dyn =
  wrap_plots(
    list(
      plot_intake_gen,
      plot_dist_gen,
      plots_wt_evo[["exploit"]],
      plots_wt_evo[["interf"]]
    ),
    design = "AB\nAB\nCD\nCD\nCD"
  ) +
  plot_annotation(
    tag_levels = "A"
  ) &
  theme(
    plot.tag = element_text(face = "bold")
  )

# save
ggsave(
  fig_evo_dyn,
  filename = "figures/fig_evo_dyn.png",
  height = 6.5, width = 6.5
)
```

