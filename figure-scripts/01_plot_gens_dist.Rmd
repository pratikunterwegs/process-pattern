---
editor_options: 
  chunk_output_type: console
---

# Plot variation within and between scenarios

```{r}
library(data.table)
library(ggplot2)
library(colorspace)
library(patchwork)

# local funs
source("R/fun_wt_vals.R")
```

## Load data

```{r}
data = fread("data/data_gens_dist_summary.csv")

# filter data
data = data[growth == 0.01 & !type %in% c("random", "interf")]

# split by type
data = split(data, by = "type")
```

## Plot energy over time

```{r}
plot_intake_gen = lapply(data, function(df) {
  ggplot(df)+
    geom_bin2d(
      aes(
        g, intake,
        # group = rep_,
        fill = ..count../1000
      ),
      binwidth = c(10, 1)
    )+
    scico::scale_fill_scico(
      palette = "davos",
      direction = -1,
      trans = "sqrt",
      labels = scales::percent,
      breaks = c(0.01, 0.15),
      limits = c(0.005, 0.15),
      na.value = "transparent"
    )+
    theme_test(
      base_size = 8
    )+
    theme(
      legend.key.width = unit(5, units = "mm"),
      legend.key.height = unit(1, units = "mm")
    )+
    guides(
      fill = guide_colorbar(
        title.vjust = 1
      )
    )+
    coord_cartesian(
      expand = F,
      xlim = c(-10, 260),
      ylim = c(0, 50)
    )+
    labs(
      y = "Per capita intake",
      x = "Generation",
      fill = "% Agents"
    )
})

plot_intake_gen =
  wrap_plots(
  plot_intake_gen, 
  guides = "collect") +
  plot_layout(tag_level = "new") & 
  theme(legend.position = "bottom")
```

## Summarise weight evolution

```{r}
data_wt = rbindlist(data)[, c("id", "g", "growth", "type", "rep_",
                      sprintf("wt_%i", seq(2, 4, 1)))]

# count props
data_wt_count = melt(data_wt, id.vars = c("id", "g", "growth", "type", "rep_"))
data_wt_count[, value := cut_wt_lower(value, steps = 25, scale = 40)]
data_wt_count = data_wt_count[, list(pW = .N / 100), 
              by = c("growth", "g", "type", "rep_", "variable", "value")]

# rename weights
data_wt_count[, variable := dplyr::case_when(
  variable == "wt_2" ~ "sN",
  variable == "wt_3" ~ "sH",
  variable == "wt_4" ~ "sP"
)]

# set levels
data_wt_count[, variable := factor(variable, levels = c("sP", "sH", "sN"))]

# subset for index case
data_wt_count = data_wt_count[growth == 0.01 & type != "random" & rep_ == 2, ]

data_wt_count = split(data_wt_count, by = "type")
```


```{r}
plot_wt_evo = function(df) {
  ggplot(df)+
    geom_hline(
      yintercept = 0, lty = 2,
      col = "grey"
    )+
    geom_tile(
      aes(g, value, fill = pW),
      width = 10
    )+
    scale_fill_continuous_sequential(
      palette = "Inferno",
      rev = T,
      trans = "sqrt",
      limits = c(0.02, 1),
      breaks = c(0.02, 0.25, 1),
      na.value = "transparent",
      label = scales::percent
    )+
    scale_y_continuous(
      trans = ggallin::ssqrt_trans,
      breaks = c(-1, 0, 1)
    )+
    scale_x_continuous(
      breaks = c(0, 50, 150, 250)
    )+
    facet_grid(
      ~variable, scales = "free_y",
      labeller = labeller(
        rep_ = label_both
      )
    )+
    theme_test(
      base_size = 8
    )+
    theme(
      legend.position = "top",
      legend.key.height = unit(1, "mm"),
      legend.key.width = unit(5, units = "mm"),
      strip.background = element_blank(),
      strip.text = element_text(
        face = "italic"
      )
    )+
    guides(
      fill = guide_colorbar(
        title.vjust = 1
      )
    )+
    coord_cartesian(
      ylim = c(-1, 1),
      xlim = c(0, 250)
    )+
    labs(
      x = "Generation",
      y = "Scaled weight value",
      fill = "% Agents"
    )
}
```

```{r}
# apply fun over data
plots_wt_evo = lapply(data_wt_count[c("exploit", "obligate")], plot_wt_evo)
plots_wt_evo = wrap_plots(
  plots_wt_evo, 
  guides = "collect") +
  plot_layout(tag_level = "new") & 
  theme(legend.position = "bottom")
```

## Make Figure 1

```{r figure_1}
# make figure 1
fig_1 =
  wrap_plots(
  plot_intake_gen
) / wrap_plots(plots_wt_evo) &
  plot_annotation(
    tag_levels = c("A", 1)
  ) &
  theme(
    plot.tag = element_text(
      face = "bold",
      size = 10
    )
  )

# save figure 1
ggsave(
  fig_1,
  filename = "figures/fig_01.png",
  height = 170,
  width = 150, units = "mm"
)
```
