---
editor_options: 
  chunk_output_type: console
---

# Plot SSF coefficients _vs_ agent weights

```{r}
library(data.table)
library(ggplot2)
library(colorspace)
library(patchwork)

# cut wt fun
source("R/fun_wt_vals.R")
```

## Read data

```{r}
paths = list.files("data/ssf_fits", full.names = T)
data = lapply(paths, fread)

data = rbindlist(data)
```

## Read agent weights

```{r}
wt_data = fread("data/data_lt_wt_gens.csv")
wt_data = wt_data[, c("id", "growth", "type", "rep_", 
                      sprintf("wt_%i", c(2, 3, 4)))]

setnames(wt_data, old = c("wt_2", "wt_3", "wt_4"), 
         new = c("sN", "sH", "sP"))

# melt
# wt_data = melt(wt_data, id.vars = c("id", "growth", "type", "rep_"),
#   variable.name = "weight", value.name = "wt_val")
```

## Link coefficients and weights

```{r}
# select only significant predictors
data = data[p.value <= 0.05, !(c("std.error", "statistic"))]
data = data[, !("p.value")]

data[, term := dplyr::case_when(
  term == "cell_r" ~ "ssf_R"
)]

data = dcast(data, id + growth + type + rep_ ~ term, value.var = "estimate")

data = merge(data, wt_data, 
             by.x = c("id", "growth", "rep_", "type"), 
             by.y = c("id", "growth", "rep_", "type"),
             all.x = T, all.y = F)

data = data[id < 100,]
```

```{r}
# class agents on wights
data[, cluster := apply(
  data[, c("sN", "sH", "sP")], 1, function(x){
    which.max(abs(x))
  })
]
data[, cluster := dplyr::case_when(
  cluster == 1 ~ "Nhnd",
  cluster == 2 ~ "Hand",
  cluster == 3 ~ "Prey"
)]
data[, cluster := factor(cluster, levels = c("Prey", "Hand", "Nhnd"))]

data = split(data, by = "type")
```

```{r}
plots = lapply(data, function(df) {
  ggplot(df)+
    geom_hline(
      yintercept = 0,
      lty = 2,
      col = 2
    )+
  ggdist::stat_halfeye(
    aes(factor(growth), ssf_R,
        fill = growth),
    col = "grey20",
    alpha = 0.5,
    point_colour = NA,
    .width = 0,
    adjust = .5,
    show.legend = F
  )+
  geom_jitter(
    aes(
      factor(growth), ssf_R
    ),
    # col = "grey",
    alpha = 0.1,
    shape = 1,
    size = 0.2,
    width = 0.03
  )+
  geom_boxplot(
    aes(
      factor(growth), ssf_R
    ),
    width = .15, 
    outlier.shape = NA,
    position = position_dodge()
  ) +
  scale_fill_continuous_sequential(
    palette = "Terrain 2"
  )+
  # facet_wrap(~ type, scales = "free_y")+
  coord_flip()+
  theme_classic(
    base_size = 10
  )+
  theme(
    axis.title.x = ggtext::element_markdown(),
    axis.title.y = ggtext::element_markdown(),
    axis.text.y = element_text(
      angle = 90,
      hjust = 0.5
    ),
    legend.position = "top",
    legend.key.height = unit(2, "mm")
  )+
  labs(
    y = "Relative selection for <i>r<i>",
    x = "Landscape productivity *r<sub>max</sub>*"
  )
})
```

```{r}
wrap_plots(
  plots
) +
```


```{r}
plot_cluster = lapply(data, function(df) {
    ggplot(df[growth %in% c(0.01, 0.0033, 0.03)])+
      geom_jitter(
        aes(
          cluster, ssf_R,
          col = cluster
        ),
        size = 0.1,
        alpha = 0.2,
        show.legend = F
      )+
      geom_boxplot(
        aes(cluster, ssf_R),
        fill = "grey",
        alpha = 0.4,
        show.legend = F,
        outlier.colour = "grey40",
        outlier.shape = 1,
        width = 0.4
      )+
      scale_colour_manual(
        values = c(
          "Prey" = "darkgreen",
          "Nhnd" = "indianred1",
          "Hand" = "steelblue"
        ),
        breaks = c("Prey", "Hand", "Nhnd"),
        labels = c("sP", "sH", "sN")
      )+
      scale_x_discrete(
        breaks = c("Prey", "Hand", "Nhnd"),
        labels = c("sP", "sH", "sN")
      )+
      facet_wrap(
        ~growth, 
        ncol = 3, 
        scales = "free_y",
        labeller = labeller(
          growth = label_both,
          .multi_line = F
        ), 
        drop = F
      )+
      theme_classic(base_size = 10)+
      theme(
        legend.position = "top",
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 8),
        strip.background = element_blank(),
        strip.text = element_text(
          face = "italic",
          size = 6
        ),
        panel.grid.minor = element_blank(),
        axis.title.y = ggtext::element_markdown()
      )+
      coord_cartesian(
        expand = T,
        xlim = c(1, 3),
        ylim = c(-1, 8)
      )+
      labs(
        y = "Relative selection for *r*",
        x = "Strongest weight",
        fill = "Strongest weight"
      )
  })
```

```{r}
fig_ssf = 
  wrap_plots(
  append(
    plots,
    plot_cluster
  )
) +
  plot_annotation(
    tag_levels = "A"
  ) &
  theme(
    plot.tag = element_text(
      face = "bold"
    )
  )

ggsave(
  fig_ssf,
  filename = "figures/fig_ssf.png",
  width = 6,
  height = 6
)
```

