---
editor_options: 
  chunk_output_type: console
---

# Plot variation within and between scenarios

```{r}
library(data.table)
library(ggplot2)
library(colorspace)
library(patchwork)

# cut wt fun
source("R/fun_wt_vals.R")
```

## Figure functional variation

```{r}
data_sc_wt = fread("data/data_lt_wts_scaled.csv")
data_sc_wt = data_sc_wt[growth %in% c(0.01, 0.03) & rep_ == 2]

# assign strategy
data_sc_wt[, move_strategy := dplyr::case_when(
  wt_4 > 0.6 ~ "prey tracking",
  ((wt_4 > 0) & (wt_3 > 0) & (abs(wt_4 - wt_3) < 0.1))  ~ "prey and handler tracking",
  wt_3 > 0.5 ~ "handler tracking",
  wt_3 < -0.5 ~ "handler avoiding",
  wt_2 > 0.5 ~ "non-handler tracking",
  wt_2 < -0.5 ~ "non-handler avoiding",
  T ~ "other"
)]
```

## Figures for movement paths

```{r}
data = fread("data/data_lt_plot.csv")[growth %in% c(0.01) & 
                                        interval %in% c(3, 6),]

# select 2 agents per strategy
data[, uid := id %in% first(unique(id)), 
     by = c("growth", "type", "move_strategy", "comp_strat")]
data = data[(uid),]

# remove some strategies
data = data[
  (type == "exploit" & (move_strategy %in% c(
    "prey tracking", "prey and handler tracking", "non-handler avoiding",
    "handler tracking"))) |
    (type == "obligate" & (move_strategy %in% c(
      "non-handler avoiding", "handler avoiding", "handler tracking")))
]

# remove manually
data = data[!(comp_strat == "klept" & move_strategy == "handler avoiding")]

data = data[type != "interf"]
```

```{r}
data = split(data, by = "type")

plot_move = lapply(data, function(df) {  
  ggplot(df)+
    geom_path(
      aes(
        x_wrap, y_wrap, 
        group = interaction(id, interval, growth, rep_),
        col = move_strategy
      ),
      show.legend = F
    )+
    scale_colour_manual(
        values = c(
          "prey tracking" = "darkgreen",
          "prey and handler tracking" = "darkblue",
          "non-handler avoiding" = "red",
          "handler avoiding" = "orange",
          "handler tracking" = "steelblue"
        ),
        breaks = c(
          "prey tracking",
          "handler tracking",
          "prey and handler tracking",
          "non-handler avoiding",
          "handler avoiding"
        )
      )+
    facet_wrap(
      comp_strat ~ interval, 
      labeller = labeller(
        .multi_line = F,
        move_strategy = c(
          "prey tracking" = "Prey tracking",
          "handler tracking" = "Handler tracking",
          "prey and handler tracking" = "Prey & handler tracking",
          "non-handler avoiding" = "N. handler avoiding",
          "handler avoiding" = "Handler avoiding"
        ),
        growth = label_both,
        interval = c(
          "3" = "T: 3,000 - 4,000",
          "6" = "T: 6,000 - 7,000"
        )
      )
    )+
    theme_minimal(base_size = 10)+
    theme(
      legend.position = "top",
      strip.text = element_text(
        face = "italic"
      ),
      legend.text = element_text(size = 8),
      legend.title = element_text(size = 8),
      # legend.key.width = unit(2, "mm"),
      legend.key.height = unit(2, "mm"),
      strip.background = element_blank(),
      axis.title = element_blank(),
      # axis.ticks = element_blank(),
      panel.grid.minor = element_blank(),
      panel.grid.major = element_line(
        linetype = 1, size = 0.2
      ),
      panel.border = element_rect(
        colour = "grey20",
        fill = NA,
        size = 0.1
      )
    )+
    coord_equal(
      # xlim = c(-60, 60),
      # ylim = c(-60, 60)
    )+
    guides(
      colour = guide_legend(override.aes = list(
        size = 2
      )
      # nrow = 2, byrow = T, ncol = 2
      )
    )+
    labs(
      colour = NULL
    )
})

plot_move = wrap_plots(
  plot_move, guides = "collect",
  ncol = 1,
  design = "AA\nBB\nBB"
) + plot_layout(tag_level = "new")&
  theme(legend.position = "top")
```

## Figure movement distance distribution

```{r}
# get path summaries
paths = list.files(path = "data/lt_tracks", full.names = T)
# read files
data_stats = lapply(paths, fread)
# bind data
data_stats = rbindlist(data_stats)[growth == 0.01]

# link to data_stats
data_stats = merge(data_stats[, !(c("wt_2", "wt_3", "wt_4"))], data_sc_wt, 
                   by = c("id", "growth", "type", "rep_", "intake", "gen"))

# subset data for interesting strats
data_stats = data_stats[
  (type == "exploit" & (move_strategy %in% c(
    "prey tracking", "prey and handler tracking", "non-handler avoiding",
    "handler tracking"))) |
    (type == "obligate" & (move_strategy %in% c(
      "non-handler avoiding", "handler avoiding", "handler tracking")))
]

# only index growth

# split data
data_stats = split(data_stats, by = "type")
```

### Make plot

```{r}
plot_dist_hist =
  lapply(data_stats, function(df) {
    ggplot(df)+
      geom_histogram(
        aes(
          x = distance,
          fill = move_strategy
        ),
        binwidth = 5,
        alpha = 0.6,
        position = "identity"
      )+
      scale_fill_manual(
        values = c(
          "prey tracking" = "darkgreen",
          "prey and handler tracking" = "darkblue",
          "non-handler avoiding" = "red",
          "handler avoiding" = "orange",
          "handler tracking" = "steelblue"
        ),
        breaks = c(
          "prey tracking",
          "handler tracking",
          "prey and handler tracking",
          "non-handler avoiding",
          "handler avoiding"
        )
      )+
      facet_grid(
        ~ comp_strat,
        labeller = labeller(
          .multi_line = F
        )
      )+
      theme_test(base_size = 10)+
      theme(
        legend.position = "top",
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 8),
        # legend.key.width = unit(2, "mm"),
        legend.key.height = unit(1, "mm"),
        strip.background = element_blank(),
        strip.text = element_text(
          face = "italic"
        ),
        panel.grid.minor = element_blank()
      )+
      coord_cartesian(
        expand = T
        # xlim = c(0, 100)
      )+
      guides(
        colour = guide_legend(override.aes = list(
          size = 2
        )#,
        # nrow = 2, byrow = T, ncol = 2
        )
      )+
      labs(
        fill = NULL,
        y = "# Tracks",
        x = "Distance"
      )
  })

plot_dist_hist = wrap_plots(plot_dist_hist, guides = "collect", ncol = 1) +
  plot_layout(tag_level = "new") &
  theme(legend.position = "bottom")
```

## Wrap all plots

```{r}
fig_id_var =
  wrap_plots(
    # plot_scaled_wt,
    plot_move,
    plot_dist_hist,
    # design = "AABBCC"#, 
    guides = "collect"
  ) +
  plot_annotation(tag_levels = c("A", 1)) &
  theme(
    legend.position = "top",
    plot.tag = element_text(face = "bold")
  )

ggsave(
  plot = fig_id_var,
  filename = "figures/fig_03.png",
  width = 8,
  height = 6
)
```

