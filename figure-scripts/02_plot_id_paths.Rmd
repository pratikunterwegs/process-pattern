---
editor_options: 
  chunk_output_type: console
---

# Plot variation within and between scenarios

```{r}
library(data.table)
library(ggplot2)
library(colorspace)
library(patchwork)

# cut wt fun
source("R/fun_wt_vals.R")
```

## Figures for movement paths

```{r}
data = fread("data/data_lt_plot.csv")[growth %in% c(0.01, 0.03) & 
                                        interval %in% c(3, 6),]
```

```{r}
data = split(data, by = c("type"))
```

```{r}
label_interval = c(
  # "1000" = "T:   500 - 1,500",
  "3" = "T: 3,000 - 4,000",
  "6" = "T: 6,000 - 7,000"
  # "8000" = "T: 7,500 - 8,500"
)

make_id_plots = function(df, type) {
  ggplot(df)+
    geom_hline(
      yintercept = 0, size = 0.1, col = "grey",
      lty = 2
    )+
    geom_vline(
      xintercept = 0, size = 0.1, col = "grey",
      lty = 2
    )+
  geom_path(
    aes(x_wrap, y_wrap,
        group = interaction(id, interval),
        col = factor(id)),
    show.legend = F
  )+
  scale_color_manual(
    values = ggdark::invert_color(
      sequential_hcl(4, palette = "Batlow", l1 = 30)
    )
  )+
  facet_grid(
    growth ~ interval,
    # ncol = 2,
    labeller = labeller(
      interval = label_interval,
      growth = label_both
    ),
    switch = "y"
  )+
  coord_cartesian(
    xlim = c(-70, 70),
    ylim = c(-70, 70),
    expand = F
  )+
  theme_minimal(base_size = 10)+
  theme(
    strip.text = element_text(
      face = "italic"
    ),
    strip.background = element_rect(
      fill = "grey90",
      colour = "transparent"
    ),
    axis.title = element_blank(),
    # axis.ticks = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(
      linetype = 1, size = 0.2
    ),
    panel.border = element_rect(
      colour = "grey",
      fill = NA,
      size = 0.1
    )
  )
}
```


```{r}
plots = Map(data, names(data), f = make_id_plots)

plot_move =
  wrap_plots(
  plots[c("exploit", "interf")],
  ncol = 1
)
```

## Figures for path statistics

```{r}
data_sc_wt = fread("data/data_lt_wts_scaled.csv")
data_sc_wt = data_sc_wt[growth %in% c(0.01, 0.03) & rep_ == 2]

# split data
# data_sc_wt = split(data_sc_wt, by = "type")
```

```{r}
# plots = lapply(data_sc_wt, function(df) {
plot_scaled_wt = 
  ggplot(data_sc_wt)+
    geom_hline(
      yintercept = 0, size = 0.1,
      col = "red"
    )+
    geom_vline(
      xintercept = 0, size = 0.1,
      col = "red"
    )+
    geom_jitter(
      aes(wt_4, wt_3, fill = wt_2),
      shape = 21, col = "transparent",
      show.legend = T
    )+
    scale_fill_continuous_sequential(
      palette = "Batlow", 
      rev = F,
      limits = c(-1, 1),
      alpha = 1
    )+
    scale_x_continuous(
      # trans = ggallin::ssqrt_trans
    )+
    scale_y_continuous(
      # trans = ggallin::ssqrt_trans
    )+
    facet_wrap(
      type ~ growth, 
      ncol = 2, 
      scales = "free_x",
      labeller = labeller(
        .multi_line = F,
        growth = label_both,
        type = c(
          "exploit" = "Exploit. comp.",
          "interf" = "Interf. comp."
        )
      )
    )+
    coord_cartesian(
      expand = T,
      xlim = c(-1, 1),
      ylim = c(-1, 1)
    )+
    theme_classic(
      base_size = 10
    )+
    theme(
      panel.grid.minor = element_blank(),
      panel.border = element_rect(
        colour = "grey",
        fill = NA,
        size = 0.1
      ),
      strip.background = element_blank(),
      strip.text = element_text(
        face = "italic"
      ),
      legend.position = "top",
      legend.key.height = unit(1, "mm")
    )+
    labs(
      x = "sP",
      y = "sH",
      fill = "sN"
    )
```

### Get data and cluster by strongest move weight

```{r}
# get path summaries
paths = list.files(path = "data/lt_tracks", full.names = T)
# read files
data_stats = lapply(paths, fread)
# bind data
data_stats = rbindlist(data_stats)

# link to data_stats
data_stats = merge(data_stats[, !(c("wt_2", "wt_3", "wt_4"))], data_sc_wt, 
                   by = c("id", "growth", "type", "rep_", "intake", "gen"))

# class agents on wights
data_stats[, cluster := apply(
  data_stats[, c("wt_2", "wt_3", "wt_4")], 1, function(x){
    which.max(abs(x))
  })
]

data_stats[, cluster := dplyr::case_when(
  cluster == 1 ~ "sN",
  cluster == 2 ~ "sH",
  cluster == 3 ~ "sP"
)]
data_stats[, cluster := factor(cluster, levels = c("sP", "sH", "sN"))]
```

### Make plot

```{r}
plot_dist_hist =
  ggplot(data_stats[type != "random" & rep_ == 2])+
  geom_histogram(
    aes(
      distance,
      fill = cluster
    ),
    alpha = 0.9,
    binwidth = 2,
    position = "identity"
  )+
  scale_fill_manual(
    values = c(
      "sP" = "darkgreen",
      "sN" = "indianred1",
      "sH" = "steelblue"
    ),
    # breaks = c("Prey", "Hand", "Nhnd"),
    labels = c("sP", "sH", "sN")
  )+
  facet_wrap(type ~ growth, ncol = 2, scales = "free_x",
             labeller = labeller(
               .multi_line = F,
               growth = label_both,
               type = c(
                 "exploit" = "Exploit. comp.",
                 "interf" = "Interf. comp."
               )
             )
  )+
  theme_classic(base_size = 10)+
  theme(
    legend.position = "top",
    legend.text = element_text(size = 8),
    legend.title = element_text(size = 8),
    legend.key.width = unit(1, "mm"),
    legend.key.height = unit(1, "mm"),
    strip.background = element_blank(),
    strip.text = element_text(
      face = "italic"
    ),
    panel.grid.minor = element_blank()
  )+
  coord_cartesian(
    expand = F,
    xlim = c(0, 100)
  )+
  labs(
    y = "# Tracks",
    x = "Distance",
    fill = "Strongest weight"
  )
```

## Wrap all plots

```{r}
fig_id_var =
  wrap_plots(
    plot_move,
    plot_scaled_wt,
    plot_dist_hist,
    ncol = 2,
    design = "AAABBB\nAAACCC"
  ) +
  plot_annotation(tag_levels = "A") &
  theme(
    plot.tag = element_text(face = "bold")
  )

ggsave(
  plot = fig_id_var,
  filename = "figures/fig_id_variation_distance.png",
  width = 8,
  height = 8
)
```

